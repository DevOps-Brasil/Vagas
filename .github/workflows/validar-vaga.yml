name: Validar e Classificar Vaga
on:
  issues:
    types: ["opened", "edited"]

jobs:
  validar-vaga:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Verificar campos obrigat√≥rios
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';

            // Lista de campos obrigat√≥rios do template
            const camposObrigatorios = [
              { nome: 'Cargo', regex: /###\s*üéØ\s*Cargo\s*\n\n(.+)/i },
              { nome: 'Empresa', regex: /###\s*üè¢\s*Empresa\s*\n\n(.+)/i },
              { nome: 'N√≠vel', regex: /###\s*üìä\s*N√≠vel de Experi√™ncia\s*\n\n(.+)/i },
              { nome: 'Modalidade', regex: /###\s*üè†\s*Modalidade de Trabalho\s*\n\n(.+)/i },
              { nome: 'Localiza√ß√£o', regex: /###\s*üìç\s*Localiza√ß√£o\s*\n\n(.+)/i },
              { nome: 'Contrata√ß√£o', regex: /###\s*üìù\s*Tipo de Contrata√ß√£o\s*\n\n(.+)/i },
              { nome: 'Descri√ß√£o', regex: /###\s*üìã\s*Descri√ß√£o da Vaga\s*\n\n([\s\S]+?)(?=###|$)/i },
              { nome: 'Requisitos', regex: /###\s*‚úÖ\s*Requisitos T√©cnicos\s*\n\n([\s\S]+?)(?=###|$)/i },
              { nome: 'Como Candidatar', regex: /###\s*üìß\s*Como se Candidatar\s*\n\n([\s\S]+?)(?=###|$)/i }
            ];

            const camposFaltando = [];
            const camposPreenchidos = {};

            for (const campo of camposObrigatorios) {
              const match = body.match(campo.regex);
              if (!match || !match[1] || match[1].trim() === '' || match[1].trim() === '_No response_') {
                camposFaltando.push(campo.nome);
              } else {
                camposPreenchidos[campo.nome] = match[1].trim();
              }
            }

            // Se faltam campos, adiciona coment√°rio e label
            if (camposFaltando.length > 0) {
              const mensagem = `## ‚ö†Ô∏è Informa√ß√µes Pendentes

            Ol√°! Obrigado por publicar sua vaga no **DevOps Brasil Vagas**! üöÄ

            Para que sua vaga seja melhor indexada e encontrada pelos candidatos, por favor complete os seguintes campos:

            ${camposFaltando.map(c => `- ‚ùå **${c}**`).join('\n')}

            Por favor, edite a issue e preencha os campos faltantes usando o [template de vagas](https://github.com/DevOps-Brasil/Vagas/issues/new/choose).

            ---
            *Esta √© uma mensagem autom√°tica do bot de valida√ß√£o.*`;
              
              // Adiciona coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: mensagem
              });
              
              // Adiciona label de pendente
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['Pendente de informa√ß√µes']
              });
              
              return;
            }

            // Remove label de pendente se existir e todos campos est√£o OK
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'Pendente de informa√ß√µes'
              });
            } catch (e) {
              // Label n√£o existe, ignorar
            }

            console.log('‚úÖ Vaga validada com sucesso!');
            console.log('Campos preenchidos:', camposPreenchidos);

  classificar-nivel:
    runs-on: ubuntu-latest
    needs: validar-vaga
    permissions:
      issues: write
    steps:
      - name: Adicionar label de n√≠vel
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title.toLowerCase();

            // Mapeamento de n√≠veis
            const niveis = {
              'Est√°gio': 'Est√°gio',
              'J√∫nior': 'J√∫nior',
              'Pleno': 'Pleno',
              'S√™nior': 'S√™nior',
              'Especialista/Staff': 'Especialista',
              'Tech Lead': 'Tech Lead',
              'Coordena√ß√£o/Ger√™ncia': 'Gest√£o'
            };

            // Busca n√≠vel no body (template)
            const nivelMatch = body.match(/###\s*üìä\s*N√≠vel de Experi√™ncia\s*\n\n(.+)/i);
            let labelNivel = null;

            if (nivelMatch && nivelMatch[1]) {
              const nivelSelecionado = nivelMatch[1].trim();
              labelNivel = niveis[nivelSelecionado];
            }

            // Fallback: busca no t√≠tulo
            if (!labelNivel) {
              if (title.includes('junior') || title.includes('j√∫nior') || title.includes('jr')) {
                labelNivel = 'J√∫nior';
              } else if (title.includes('pleno') || title.includes('mid')) {
                labelNivel = 'Pleno';
              } else if (title.includes('senior') || title.includes('s√™nior') || title.includes('sr')) {
                labelNivel = 'S√™nior';
              } else if (title.includes('lead') || title.includes('l√≠der')) {
                labelNivel = 'Tech Lead';
              } else if (title.includes('estag') || title.includes('intern')) {
                labelNivel = 'Est√°gio';
              }
            }

            if (labelNivel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [labelNivel]
              });
              console.log(`‚úÖ Label de n√≠vel adicionada: ${labelNivel}`);
            }

  classificar-contratacao:
    runs-on: ubuntu-latest
    needs: validar-vaga
    permissions:
      issues: write
    steps:
      - name: Adicionar label de contrata√ß√£o
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title.toLowerCase();

            // Mapeamento de contrata√ß√£o
            const contratacoes = {
              'CLT': 'CLT',
              'PJ': 'PJ',
              'CLT ou PJ': ['CLT', 'PJ'],
              'Cooperado': 'Cooperado',
              'Freelancer': 'Freelancer',
              'Est√°gio': 'Est√°gio'
            };

            // Busca contrata√ß√£o no body (template)
            const contratacaoMatch = body.match(/###\s*üìù\s*Tipo de Contrata√ß√£o\s*\n\n(.+)/i);
            let labels = [];

            if (contratacaoMatch && contratacaoMatch[1]) {
              const contratacaoSelecionada = contratacaoMatch[1].trim();
              const label = contratacoes[contratacaoSelecionada];
              if (Array.isArray(label)) {
                labels = label;
              } else if (label) {
                labels = [label];
              }
            }

            // Fallback: busca no t√≠tulo/body
            if (labels.length === 0) {
              const texto = (title + ' ' + body).toLowerCase();
              if (texto.includes('clt')) labels.push('CLT');
              if (texto.includes('pj') || texto.includes('pessoa jur√≠dica')) labels.push('PJ');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              console.log(`‚úÖ Labels de contrata√ß√£o adicionadas: ${labels.join(', ')}`);
            }

  classificar-modalidade:
    runs-on: ubuntu-latest
    needs: validar-vaga
    permissions:
      issues: write
    steps:
      - name: Adicionar label de modalidade
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title.toLowerCase();

            // Mapeamento de modalidade
            const modalidades = {
              'Remoto': 'Remoto',
              'H√≠brido': 'H√≠brido',
              'Presencial': 'Presencial'
            };

            // Busca modalidade no body (template)
            const modalidadeMatch = body.match(/###\s*üè†\s*Modalidade de Trabalho\s*\n\n(.+)/i);
            let labelModalidade = null;

            if (modalidadeMatch && modalidadeMatch[1]) {
              const modalidadeSelecionada = modalidadeMatch[1].trim();
              labelModalidade = modalidades[modalidadeSelecionada];
            }

            // Fallback: busca no t√≠tulo
            if (!labelModalidade) {
              if (title.includes('remoto') || title.includes('remote')) {
                labelModalidade = 'Remoto';
              } else if (title.includes('h√≠brido') || title.includes('hibrido') || title.includes('hybrid')) {
                labelModalidade = 'H√≠brido';
              } else if (title.includes('presencial') || title.includes('on-site') || title.includes('onsite')) {
                labelModalidade = 'Presencial';
              }
            }

            if (labelModalidade) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [labelModalidade]
              });
              console.log(`‚úÖ Label de modalidade adicionada: ${labelModalidade}`);
            }
