name: Classificar LocalizaÃ§Ã£o e SalÃ¡rio
on:
  issues:
    types: ["opened", "edited"]

jobs:
  classificar-localizacao:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Adicionar labels de localizaÃ§Ã£o
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title;

            // Estados brasileiros
            const estados = {
              'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'AmapÃ¡', 'AM': 'Amazonas',
              'BA': 'Bahia', 'CE': 'CearÃ¡', 'DF': 'Distrito Federal', 'ES': 'EspÃ­rito Santo',
              'GO': 'GoiÃ¡s', 'MA': 'MaranhÃ£o', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul',
              'MG': 'Minas Gerais', 'PA': 'ParÃ¡', 'PB': 'ParaÃ­ba', 'PR': 'ParanÃ¡',
              'PE': 'Pernambuco', 'PI': 'PiauÃ­', 'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte',
              'RS': 'Rio Grande do Sul', 'RO': 'RondÃ´nia', 'RR': 'Roraima', 'SC': 'Santa Catarina',
              'SP': 'SÃ£o Paulo', 'SE': 'Sergipe', 'TO': 'Tocantins'
            };

            // Principais cidades (para labels especÃ­ficas)
            const cidadesImportantes = [
              'SÃ£o Paulo', 'Rio de Janeiro', 'Belo Horizonte', 'BrasÃ­lia', 
              'Curitiba', 'Porto Alegre', 'Salvador', 'Recife', 'Fortaleza',
              'FlorianÃ³polis', 'Campinas', 'GoiÃ¢nia', 'Manaus', 'VitÃ³ria',
              'MaringÃ¡', 'Joinville', 'Blumenau', 'Londrina', 'UberlÃ¢ndia'
            ];

            // Busca localizaÃ§Ã£o no body (template)
            const localizacaoMatch = body.match(/###\s*ðŸ“\s*LocalizaÃ§Ã£o\s*\n\n(.+)/i);
            const localizacao = localizacaoMatch ? localizacaoMatch[1] : '';
            const texto = (title + ' ' + localizacao + ' ' + body).normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            const labelsParaAdicionar = new Set();

            // Detecta se Ã© internacional
            const internacional = /internacional|global|worldwide|usa|estados unidos|europa|latam|america latina/i;
            if (internacional.test(texto)) {
              labelsParaAdicionar.add('Internacional');
            }

            // Detecta se aceita de qualquer lugar do Brasil
            const brasilInteiro = /brasil inteiro|todo brasil|qualquer (lugar|estado|cidade)|anywhere in brazil/i;
            if (brasilInteiro.test(texto)) {
              labelsParaAdicionar.add('Brasil');
            }

            // Detecta estados
            for (const [sigla, nome] of Object.entries(estados)) {
              // Busca pela sigla (ex: SP, RJ) ou nome completo
              const regexSigla = new RegExp(`\\b${sigla}\\b`, 'i');
              const nomeNormalizado = nome.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              const regexNome = new RegExp(nomeNormalizado, 'i');
              
              if (regexSigla.test(texto) || regexNome.test(texto)) {
                labelsParaAdicionar.add(sigla);
              }
            }

            // Detecta cidades importantes (para mapeamento de estado)
            const cidadeEstado = {
              'SÃ£o Paulo': 'SP', 'Campinas': 'SP',
              'Rio de Janeiro': 'RJ',
              'Belo Horizonte': 'MG', 'UberlÃ¢ndia': 'MG',
              'BrasÃ­lia': 'DF',
              'Curitiba': 'PR', 'Londrina': 'PR', 'MaringÃ¡': 'PR',
              'Porto Alegre': 'RS',
              'Salvador': 'BA',
              'Recife': 'PE',
              'Fortaleza': 'CE',
              'FlorianÃ³polis': 'SC', 'Joinville': 'SC', 'Blumenau': 'SC',
              'GoiÃ¢nia': 'GO',
              'Manaus': 'AM',
              'VitÃ³ria': 'ES'
            };

            for (const [cidade, estado] of Object.entries(cidadeEstado)) {
              const cidadeNormalizada = cidade.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              if (texto.toLowerCase().includes(cidadeNormalizada.toLowerCase())) {
                labelsParaAdicionar.add(estado);
              }
            }

            // Adiciona labels
            if (labelsParaAdicionar.size > 0) {
              const labels = Array.from(labelsParaAdicionar);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              console.log(`âœ… Labels de localizaÃ§Ã£o adicionadas: ${labels.join(', ')}`);
            }

  classificar-salario:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Adicionar label de faixa salarial
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            // Busca salÃ¡rio no body (template)
            const salarioMatch = body.match(/###\s*ðŸ’°\s*Faixa Salarial\s*\n\n(.+)/i);
            if (!salarioMatch || !salarioMatch[1] || salarioMatch[1].trim() === '_No response_') {
              console.log('â„¹ï¸ Faixa salarial nÃ£o informada');
              return;
            }

            const salarioTexto = salarioMatch[1].trim();

            // Se Ã© "a combinar", nÃ£o adiciona label
            if (/a combinar|negoci[aÃ¡]vel|competitivo/i.test(salarioTexto)) {
              console.log('â„¹ï¸ SalÃ¡rio a combinar');
              return;
            }

            // Extrai valores numÃ©ricos
            // PadrÃµes: R$ 8.000, R$8000, 8.000, 8000, USD 3000, $ 3,000
            const extrairValores = (texto) => {
              const valores = [];
              
              // PadrÃ£o BRL: R$ 8.000 ou R$ 8000
              const regexBRL = /R\$\s*([\d.,]+)/gi;
              let match;
              while ((match = regexBRL.exec(texto)) !== null) {
                const valor = parseFloat(match[1].replace(/\./g, '').replace(',', '.'));
                if (!isNaN(valor)) valores.push({ valor, moeda: 'BRL' });
              }
              
              // PadrÃ£o USD: USD 3000, $ 3,000, US$ 3000
              const regexUSD = /(?:USD|US\$|\$)\s*([\d.,]+)/gi;
              while ((match = regexUSD.exec(texto)) !== null) {
                const valor = parseFloat(match[1].replace(/,/g, '').replace('.', ''));
                if (!isNaN(valor)) valores.push({ valor, moeda: 'USD' });
              }
              
              // PadrÃ£o numÃ©rico simples (assume BRL)
              if (valores.length === 0) {
                const regexNum = /(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?)/g;
                while ((match = regexNum.exec(texto)) !== null) {
                  const valor = parseFloat(match[1].replace(/\./g, '').replace(',', '.'));
                  if (!isNaN(valor) && valor >= 1000) valores.push({ valor, moeda: 'BRL' });
                }
              }
              
              return valores;
            };

            const valores = extrairValores(salarioTexto);

            if (valores.length === 0) {
              console.log('â„¹ï¸ NÃ£o foi possÃ­vel extrair valores do salÃ¡rio');
              return;
            }

            // Pega o maior valor (assume que Ã© o teto da faixa)
            // Converte USD para BRL se necessÃ¡rio (taxa aproximada)
            const taxaUSD = 5.0; // Taxa aproximada USD -> BRL
            let maiorValorBRL = 0;

            for (const v of valores) {
              const valorBRL = v.moeda === 'USD' ? v.valor * taxaUSD : v.valor;
              if (valorBRL > maiorValorBRL) maiorValorBRL = valorBRL;
            }

            // Define faixas salariais
            let labelSalario;
            if (maiorValorBRL <= 5000) {
              labelSalario = 'ðŸ’° AtÃ© R$ 5k';
            } else if (maiorValorBRL <= 8000) {
              labelSalario = 'ðŸ’° R$ 5k - 8k';
            } else if (maiorValorBRL <= 12000) {
              labelSalario = 'ðŸ’° R$ 8k - 12k';
            } else if (maiorValorBRL <= 16000) {
              labelSalario = 'ðŸ’° R$ 12k - 16k';
            } else if (maiorValorBRL <= 20000) {
              labelSalario = 'ðŸ’° R$ 16k - 20k';
            } else if (maiorValorBRL <= 25000) {
              labelSalario = 'ðŸ’° R$ 20k - 25k';
            } else if (maiorValorBRL <= 35000) {
              labelSalario = 'ðŸ’° R$ 25k - 35k';
            } else {
              labelSalario = 'ðŸ’° Acima de R$ 35k';
            }

            // Adiciona label de que tem salÃ¡rio informado
            const labels = [labelSalario, 'ðŸ’µ SalÃ¡rio Informado'];

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

            console.log(`âœ… Labels de salÃ¡rio adicionadas: ${labels.join(', ')}`);
            console.log(`â„¹ï¸ Maior valor detectado: R$ ${maiorValorBRL.toLocaleString('pt-BR')}`);

  classificar-area:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Adicionar labels de Ã¡rea/tecnologia
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title.toLowerCase();
            const texto = (title + ' ' + body).toLowerCase();

            const labelsParaAdicionar = new Set();

            // Ãreas de atuaÃ§Ã£o
            const areas = {
              'DevOps': /devops|dev\s*ops/i,
              'SRE': /\bsre\b|site reliability|reliability engineer/i,
              'Platform': /platform engineer|plataforma/i,
              'Cloud': /cloud engineer|cloud architect|engenheiro de cloud/i,
              'Infra': /infraestrutura|infrastructure|sysadmin|system admin/i,
              'Security': /devsecops|security|seguranÃ§a|appsec/i,
              'Data': /data engineer|engenheiro de dados|dataops/i,
              'FinOps': /finops|cloud cost|custo cloud/i
            };

            for (const [label, regex] of Object.entries(areas)) {
              if (regex.test(texto)) {
                labelsParaAdicionar.add(label);
              }
            }

            // Tecnologias principais
            const tecnologias = {
              'AWS': /\baws\b|amazon web services/i,
              'Azure': /\bazure\b|microsoft azure/i,
              'GCP': /\bgcp\b|google cloud|gke/i,
              'Kubernetes': /kubernetes|k8s|\beks\b|\baks\b|\bgke\b/i,
              'Terraform': /terraform/i,
              'Docker': /docker|container/i
            };

            for (const [label, regex] of Object.entries(tecnologias)) {
              if (regex.test(texto)) {
                labelsParaAdicionar.add(label);
              }
            }

            // Adiciona labels
            if (labelsParaAdicionar.size > 0) {
              const labels = Array.from(labelsParaAdicionar);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              console.log(`âœ… Labels de Ã¡rea/tecnologia adicionadas: ${labels.join(', ')}`);
            }
